{{ $id := delimit (slice "gallery" (partial "functions/uid.html" .)) "-" -}}
{{ $content := .Inner -}}
{{ $maxSize := default "1200" (.Get "maxSize") -}}
{{ $processSpec := printf "fit %sx%s webp" $maxSize $maxSize -}}

{{/* find all img tags */}}
{{ range findRE `<img\s+[^>]*>` $content -}}
  {{ $imgTag := . -}}
  {{/* extract src attribute */}}
  {{ with findRESubmatch `src=['"]([^'"]+)['"]` $imgTag -}}
    {{ $srcAttr := index (index . 0) 0 -}}
    {{ $srcValue := index (index . 0) 1 -}}
    {{ $srcValueFinal := $srcValue -}}

    {{ if or (hasPrefix $srcValue "http://") (hasPrefix $srcValue "https://") -}}
      {{ with resources.GetRemote $srcValue -}}{{ $srcValueFinal = (.Filter images.AutoOrient (images.Process $processSpec)).RelPermalink -}}{{ end -}}
    {{ else -}}
      {{ with $.Page.Resources.GetMatch $srcValue -}}
        {{ $srcValueFinal = (.Filter images.AutoOrient (images.Process $processSpec)).RelPermalink -}}
      {{ else -}}
        {{ with resources.GetMatch $srcValue -}}{{ $srcValueFinal = (.Filter images.AutoOrient (images.Process $processSpec)).RelPermalink -}}{{ end -}}
      {{ end -}}
    {{ end -}}

    {{ $newTag := replace $imgTag $srcAttr (printf `src="%s"` $srcValueFinal) -}}
    {{ $content = replace $content $imgTag $newTag -}}
  {{ end -}}
{{ end -}}

{{ if not .Parent }}<div class="width-patch"></div>{{ end }}
<div id="{{- $id -}}" class="gallery">
  {{ $content | safeHTML -}}
</div>
